---
# Install or update NetBird on Ubuntu/Debian via the official APT repository
# https://docs.netbird.io/get-started/install/linux#ubuntu-debian-apt
- name: Install NetBird
  hosts: all
  become: true
  gather_facts: true
  gather_timeout: 10
  ignore_unreachable: false

  vars:
    netbird_apt_list_path: /etc/apt/sources.list.d/netbird.list
    netbird_apt_repo: 'deb [signed-by=/usr/share/keyrings/netbird-archive-keyring.gpg] https://pkgs.netbird.io/debian stable main'
    netbird_gpg_key_path: /usr/share/keyrings/netbird-archive-keyring.gpg
    netbird_gpg_key_url: https://pkgs.netbird.io/debian/public.key
    netbird_package_names:
      - netbird
      - netbird-ui
    # Optional NetBird setup key for provisioning devices during install.
    # Provide NETBIRD_SETUP_KEY in the environment to run `netbird up`.
    # If NETBIRD_SETUP_KEY is unset or empty, `netbird up` is skipped.
    netbird_setup_key: "{{ lookup('env', 'NETBIRD_SETUP_KEY') }}"

  tasks:

    - name: Install APT prerequisites
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Download NetBird repository signing key
      ansible.builtin.get_url:
        url: '{{ netbird_gpg_key_url }}'
        dest: /tmp/netbird-public.key
        mode: '0644'
        force: true

    - name: Convert NetBird signing key to keyring
      ansible.builtin.command: >-
        gpg --dearmor --output {{ netbird_gpg_key_path }} /tmp/netbird-public.key
      args:
        creates: '{{ netbird_gpg_key_path }}'

    - name: Add NetBird APT repository
      ansible.builtin.apt_repository:
        repo: '{{ netbird_apt_repo }}'
        filename: netbird
        state: present

    - name: Update APT cache after adding NetBird repository
      ansible.builtin.apt:
        update_cache: true

    - name: Install NetBird package
      ansible.builtin.apt:
        name: '{{ netbird_package_names }}'
        state: present

    - name: Ensure NetBird service is enabled and running
      ansible.builtin.service:
        name: netbird
        state: started
        enabled: true

    - name: Run NetBird setup when setup key is provided
      ansible.builtin.command:
        argv:
          - netbird
          - up
          - --setup-key
          - '{{ netbird_setup_key }}'
      changed_when: netbird_up_result.rc == 0
      register: netbird_up_result
      when: netbird_setup_key | length > 0
