---
- name: Install LightDM and configure autologin
  hosts: all
  become: true
  gather_facts: true
  vars:
    autologin_user: '{{ ansible_user | default(ansible_user_id) }}'
    lightdm_config_path: /etc/lightdm/lightdm.conf.d/50-autologin.conf

  tasks:
    - name: Ensure LightDM packages are installed
      ansible.builtin.apt:
        name:
          - lightdm
          - lightdm-gtk-greeter
        state: present
        update_cache: true
      when:
        - ansible_facts['distribution'] == 'Ubuntu'

    - name: Set LightDM as default display manager
      ansible.builtin.debconf:
        name: lightdm
        question: shared/default-x-display-manager
        value: lightdm
        vtype: select
      when:
        - ansible_facts['distribution'] == 'Ubuntu'

    - name: Ensure LightDM config directory exists
      ansible.builtin.file:
        path: /etc/lightdm/lightdm.conf.d
        state: directory
        mode: '0755'
      when:
        - ansible_facts['distribution'] == 'Ubuntu'

    - name: Configure LightDM autologin for i3
      ansible.builtin.copy:
        dest: '{{ lightdm_config_path }}'
        mode: '0644'
        owner: root
        group: root
        content: |
          [Seat:*]
          autologin-user={{ autologin_user }}
          autologin-user-timeout=0
          user-session=i3
      when:
        - ansible_facts['distribution'] == 'Ubuntu'
